{% extends 'base.html' %}

{% block content %}
<style>
    body {padding:20px;}
    .ticketTable {border-left:1px solid #000; border-top:1px solid #000; margin:0 0 20px;}
    .ticketTable td {border-right:1px solid #000; border-bottom:1px solid #000; padding:5px;}
    .searhResults {display: {{display_search_results}};}

</style>
<div align="right"><a href="/user/">user info</a></div>
<div align="right"><a href="/booking/">booking</a></div>
<div align="right"><a href="/logout/">logout</a></div>
<h2>Tickets</h2>
<table class="ticketTable bookedTickets">
    <tr>
        <td>ID</td>
        <td>Date</td>
        <td>Time</td>
        <td>Name</td>
        <td>Price</td>
        <td>Snack</td>
        <td>Pet</td>
    </tr>
    {% for ticket in tickets %}
    <tr>
        <td>{{ticket.id}}</td>
        <td>{{ticket.performance.date|date:"d/m/Y"}}</td>
        <td>{{ticket.performance.time|time:"H:i"}}</td>
        <td>{{ticket.performance.name}}</td>
        <td>{{ticket.performance.price}}</td>
        <td><input class="snackInput_{{ticket.id}}" type="checkbox" name="snack"/></td>
        <td>
            <select class="petInput_{{ticket.id}}" name="pet">
                <option value=""></option>
                {% for feature in features %}
                    <option value="{{feature.name}}">{{feature.name}} - {{feature.price}}</option>
                {% endfor %}
            </select>
        </td>
    </tr>
    {% endfor %}
</table>

<h2>Buy Tickets</h2>
<table class="ticketTable buyInfo">
    <tr>
        <td>Total tickets to book</td>
        <td>{{tickets.count}}</td>
    </tr>
    <tr>
        <td>Total price</td>
        <td>{{stats.total_price}}</td>
    </tr>
    <tr>
        <td>Total discount</td>
        <td>{{stats.total_discount}}</td>
    </tr>
    <tr>
        <td>Final price with discount*</td>
        <td>{{stats.final_price}}</td>
    </tr>
</table>
<p>*discount +{{discounts.user_buy_counter_discount}}% for each {{discounts.user_buy_counter_limit}} not included</p>

<form action="" method="post" class="buyInfoForm">
    <ul>
        <li>
            <input type="text" class="creditCardInput" name="creditCard">
        </li>
        <li>
            <input type="text" class="couponInput" name="coupon">
        </li>
        <li>
            <input type="text" class="deliveryAddress" name="address">
        </li>

    </ul>
    <input type="submit" value="Get tickets">
</form>



<script>
var actionParam;

$('.bookingForm').on('submit', function(event){
    event.preventDefault();
    submitParams(actionParam);
    });

$('.bookBtn').click(function(event){
    actionParam='book';
});

$('.buyBtn').click(function(event){
    actionParam = 'buy';
});

function submitParams(action){
    var result = {};
    $(".ticketTable input").each(function(i, input){
       result[input.name] = input.value;
    });

    //result['csrfmiddlewaretoken'] = $('input[name=csrfmiddlewaretoken]').val();
    console.log(result);
    if(actionParam == 'book'){
        $.ajax({
        url: "/booking/book/",
        type: "post",
        dataType: "json",
        data: JSON.stringify(result),
        contentType: "application/json; charset=utf-8",
        success: positiveHandler,
        error: negativeHandler
        });
    }
}

function positiveHandler(data){
    if(data.status == 'success')
        alert(data.message);
}

function negativeHandler(data){
    var resp = data.responseJSON;
    if(resp.message){
        alert(resp.message);
        return;
    }
    alert("something went wrong :(")
}

function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
            // Only send the token to relative URLs i.e. locally.
            xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
        }
    }
});

</script>

{% endblock %}