{% extends 'base.html' %}

{% block content %}
    <div align="right"><a href="/user/">user info</a></div>
    <div align="right"><a href="/booking/">booking</a></div>
    <div align="right"><a href="/logout/">logout</a></div>

    <div class='title'>Cart</div>

    <div class='row-sm'>
        <table class='cTable ticketTable bookedTickets'>
            <thead class='cThead'>
            <tr class='cRow'>
                <td class='cTd'>Ticket Id</td>
                <td class='cTd'>Date</td>
                <td class='cTd'>Time</td>
                <td class='cTd'>Name</td>
                <td class='cTd'>Price</td>
                <td class='cTd'>Features</td>
                <td class='cTd'>Snack</td>
                <td class='cTd'>Pets: Name - Price</td>
            </tr>
            </thead>
            <tbody class='cTbody'>
            {% for ticket in tickets %}
                <tr class='cRow'>
                    <td class='cTd cTdId'>{{ ticket.id }}</td>
                    <td class='cTd cTdDate'>{{ ticket.performance.date|date:"d/m/Y" }}</td>
                    <td class='cTd cTdTime'>{{ ticket.performance.time|time:"H:i" }}</td>
                    <td class='cTd cTdTitle'>
                        <a href='javascript:;' class='showDes' id='description1'>{{ ticket.performance.name }}</a>
                    </td>
                    <td class='cTd cTdPrice priceCol ticket_{{ ticket.id }}'>{{ ticket.performance.price|floatformat }}</td>
                    <td class='cTd cTdFeatures'>
                        {% for feature in ticket.performance.features.all %}
                            <div class='featureName'>{{ feature.feature }}</div>
                        {% endfor %}
                    </td>
                    <td class='cTd cTdSnack'><input class="snackInput recalc" type="checkbox" name="{{ ticket.id }}"/>
                    </td>
                    <td class='cTd cTdPets'>
                        <div class='pets'>
                            <select class='select petInput recalc' name='{{ ticket.id }}'>
                                <option value=""></option>
                                {% for feature in features %}
                                    <option value='{{ feature.name }}'>{{ feature.name }} - {{ feature.price }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </td>
                    <td class='clr mVis'></td>
                </tr>
                <tr class='cInfo'>
                    <td colspan='8' class='cTd'>
                        <div class='desOuter description1'>
                            <p>{{ ticket.performance.description }}</p>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>


    <div class='title'>Options</div>
    <div class='row-sm'>
        <table class='cTable'>
            <thead class='cThead'>
            <tr class='cRow'>
                <td class='cTd'>Name</td>
                <td class='cTd'>Value</td>
            </tr>
            </thead>
            <tbody class='cTbody'>
            <tr class='cRow'>
                <td class='cTd cTdName'>Total tickets to buy</td>
                <td class='cTd cTdValue'>{{ tickets.count }}</td>
            </tr>
            <tr class='cRow'>
                <td class='cTd cTdName'>Total price</td>
                <td class='cTd cTdValue totalPrice'>{{ stats.total_price|floatformat }}</td>
            </tr>

            <tr class='cRow'>
                <td class='cTd cTdName'>Total discount*</td>
                <td class='cTd cTdValue totalDiscount'>{{ stats.total_discount }}</td>
            </tr>

            <tr class='cRow'>
                <td class='cTd cTdName'>Final price with discount*</td>
                <td class='cTd cTdValue'>{{ stats.final_price|floatformat }}</td>
            </tr>
            </tbody>
        </table>
        <p>*discount +{{ discounts.user_buy_counter_discount }}% for each {{ discounts.user_buy_counter_limit }} not
            included</p>
    </div>

    <div class='underCartForm'>
        <div class='row'>


            <div class='formGroup checkPlace'>
                <div class='formLabel'>Credit Card</div>
                <div class='cardInput checked'>
                    <input type='text' class='formInput creditCardInput' name="creditCard"
                           value="{{ user.profile.credit_card.card_number }}">
                </div>
            </div>

            <div class='col-sm'>
                <div class='formGroup'>
                    <div class='formLabel'>Discount Coupon</div>
                    <div class='error'>
                        <input type='text' class='formInput discountInput couponInput recalc' name="coupon">
                        <div class='errorText'>Error text</div>
                    </div>
                </div>
            </div>
            <div class='clr'></div>
            <div class='formGroup'>
                <div class='formLabel'>Delivery Address Info</div>
                <textarea placeholder='Text' class="deliveryInfo" name="address">
                            {% if user.profile.address %}
                                {{ user.profile.address }}
                            {% endif %}
                        </textarea>
            </div>
        </div>
        <div class='btnBox twoBtn'>
            <button class='defBtn buyBtn'>Buy</button>
            <button class='defBtn cancelBtn'>Cancel</button>
        </div>
    </div>


    <script>
        $('.recalc').change(function () {
            var payload = {
                'snacks': collectSnacks(),
                'pets': collectPets(),
                'coupon': $('.couponInput').val()
            };
            updatePrice(payload);
        });

        $('.buyBtn').click(function () {
            var payload = {
                'snacks': collectSnacks(),
                'pets': collectPets(),
                'coupon': $('.couponInput').val(),
                'creditCard': $('.creditCardInput').val(),
                'deliveryInfo': $('.deliveryInfo').val()
            };
            buyTickets(payload);
        })

        function collectSnacks() {
            var result = {};
            $(".snackInput").each(function (i, checkbox) {
                result[checkbox.name] = checkbox.checked;
            });
            return result;
        }

        function collectPets() {
            var result = {};
            $(".petInput").each(function (i, option) {
                result[option.name] = option.value;
            });
            return result;
        }

        function updatePrice(action) {
            $.ajax({
                url: "/payment/update/",
                type: "post",
                dataType: "json",
                data: JSON.stringify(action),
                contentType: "application/json; charset=utf-8",
                success: updatePriceOk,
                error: updatePriceNok
            });
        }

        function buyTickets(action) {
            $.ajax({
                url: "/payment/buy/",
                type: "post",
                dataType: "json",
                data: JSON.stringify(action),
                contentType: "application/json; charset=utf-8",
                success: buyOk,
                error: buyNok
            });
        }

        function updatePriceOk(data) {
            for (key in data.tickets) {
                $('.ticket_' + key).html(data.tickets[key])
            }
            $('.totalPrice').html(data.totalPrice);
            $('.totalDiscount').html(data.totalDiscount);
            $('.finalPrice').html(data.finalPrice);
            $('.couponStatus').html(data.couponStatus ? 'OK' : 'NOK');
            if ($('.couponInput').val().length == 0)
                $('.couponStatus').html('');
            $('.buyBtn').removeAttr('disabled');
        }

        function updatePriceNok(data) {
            var resp = data.responseJSON;
            $('.buyBtn').attr('disabled', 'disabled');
            if (resp.message) {
                alert(resp.message);
                return;
            }
            alert("something went wrong :(");

        }

        function buyOk(data) {
            location.href = data.redirect_url
        }

        function buyNok(data) {
            var resp = data.responseJSON;
            if (resp.message) {
                alert(resp.message);
                return;
            }
            alert("something went wrong :(")
        }

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                    // Only send the token to relative URLs i.e. locally.
                    xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                }
            }
        });

    </script>

{% endblock %}