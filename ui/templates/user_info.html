{% extends 'base.html' %}

{% block content %}
    <div align="right"><a href="/booking/">booking</a></div>
    <div align="right"><a href="/logout/">logout</a></div>
    <div class='title'>User Info</div>
    <div class='row'>

        <div class='col-sm'>
            <div class='formGroup'>
                <div class='formLabel'>Name</div>
                <input type='text' class='formInput oneMoreInput' disabled value='{{ user.username }}'>
            </div>
        </div>
        <div class='col-sm'>
            <div class='formGroup'>
                <div class='formLabel'>Email</div>
                <div class='error'>
                    <input type='text' class='formInput discountInput email' name='email'
                            {% if user.profile.email %}
                           value='{{ user.profile.email }}'
                            {% endif %}>
                    <div class='errorText'>Error text</div>
                </div>
            </div>
        </div>
        <div class='col-sm'>
            <div class='formGroup checkPlace'>
                <div class='formLabel'>Credit Card</div>
                <div class='cardInput checked'>
                    <input type='text' class='formInput creditCard' name='creditCard'
                           value='{{ user.profile.credit_card.card_number }}'>
                </div>
            </div>
        </div>
        <div class='formGroup'>
            <div class='formLabel'>Delivery Address Info</div>
            <textarea placeholder='Text' class='deliveryInfo' name='address'>
            {% if user.profile.address %}
                {{ user.profile.address }}
            {% endif %}
        </textarea>
        </div>
    </div>
    <div class='btnBox twoBtn'>
        <button class='defBtn updateInfo' name='updateInfo'>Update Info</button>
        <button class='defBtn refreshInfo' name='refreshInfo'>Refresh Info</button>
    </div>

    {% if booked_tickets_list %}
    <div class='title'>Booked Tickets</div>

    <div class='row-sm'>
        <form action="/buy" method="post" class="bookedTicketsForm">
            <table class='rTable ticketTable bookedTickets'>
                <thead class='rThead'>
                <tr class='rRow'>
                    <td class='rTd'>Ticket ID</td>
                    <td class='rTd'>Date</td>
                    <td class='rTd'>Time</td>
                    <td class='rTd'>Name</td>
                    <td class='rTd'>Price</td>
                    <td class='rTd'>Booking Time</td>
                    <td class='rTd'>Remove From Cart</td>
                </tr>
                </thead>
                <tbody class='rTbody'>
                {% for ticket in booked_tickets_list %}
                    <tr class='rRow'>
                        <td class='rTd rTdId'>{{ ticket.id }}</td>
                        <td class='rTd rTdDate'>{{ ticket.performance.date|date:"d/m/Y" }}</td>
                        <td class='rTd rTdTime'>{{ ticket.performance.time|time:"H:i" }}</td>
                        <td class='rTd rTdTitle'>
                            <a href='javascript:;' class='showDes' id='description1'>{{ ticket.performance.name }}</a>
                        </td>
                        <td class='rTd rTdPrice'>{{ ticket.performance.price|floatformat }}</td>
                        <td class='rTd rTdTimestamp'>{{ ticket.booked|date:"DATETIME_FORMAT" }}</td>
                        <td class='rTd rTdRemove'><input type='checkbox' name='{{ ticket.id }}'/></td>

                    </tr>
                    <tr class='rInfo'>
                        <td colspan='8' class='rTd'>
                            <div class='desOuter description1'>
                                <p>Mighty giants-transformers, strong, superheroes, clever tightrope walkers from hot
                                    Colombia, the spectacular show is the Italian bikers, a huge wheel of death and
                                    consummate Ukrainian trapeze artists.</p>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            <div class='btnBox twoBtn'>
                <button class='defBtn clearBtn' name='action' id='loginSubmit'>Remove Selected</button>
                <button class='defBtn buyBtn' name='action' id='loginSubmit'>Buy All</button>
            </div>
        </form>
    </div>
    {% endif %}

    {% if bought_tickets_list %}
    <div class='title'>Bought Tickets</div>

    <div class='row-sm'>
        <table class='rTable ticketTable bookedTickets'>
            <thead class='rThead'>
            <tr class='rRow'>
                <td class='rTd'>Ticket ID</td>
                <td class='rTd'>Date</td>
                <td class='rTd'>Time</td>
                <td class='rTd'>Name</td>
                <td class='rTd'>Price</td>
                <td class='rTd'>Bought Time</td>
            </tr>
            </thead>
            <tbody class='rTbody'>
            {% for ticket in bought_tickets_list %}
                <tr class='rRow'>
                    <td class='rTd rTdId'>{{ ticket.id }}</td>
                    <td class='rTd rTdDate'>{{ ticket.performance.date|date:"d/m/Y" }}</td>
                    <td class='rTd rTdTime'>{{ ticket.performance.time|time:"H:i" }}</td>
                    <td class='rTd rTdTitle'>{{ ticket.performance.name }}</td>
                    <td class='rTd rTdPrice'>{{ ticket.performance.price|floatformat }}</td>
                    <td class='rTd rTdTimestamp'>{{ ticket.bought|date:"DATETIME_FORMAT" }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

     <script>
        $('.creditCard').on('input', function (event) {
            var res = '';
            if (this.value.length >= 19) {
                this.value = this.value.substr(0, 19);
                return;
            }
            var p = this.value.replace(/\D/g, '');
            var q = [];
            var c = 0;
            do {
                var sub = p.substr(c * 4, 4);
                if (sub.length == 0)
                    break;
                q.push(sub)
            } while (c++ * 4 + 4 < p.length)
            q.forEach(function (item, i) {
                res += item;
                if (i < 3 && item.length === 4) {
                    res += '-';
                }
            });
            if (res.slice(-1) === '-')
                res = res.substr(0, res.length - 1)
            else
                this.value = res;
        })

        $('.updateInfo').click(function (event) {
            event.preventDefault();
            $.ajax({
                url: "/user/update",
                type: "post",
                dataType: "json",
                data: JSON.stringify({
                    'email': $('.email').val(),
                    'creditCard': $('.creditCard').val(),
                    'deliveryAddress': $('.deliveryInfo').val()
                }),
                contentType: "application/json; charset=utf-8",
                success: function () {
                    location.reload();
                },
                error: userUpdNegativeHandler
            });
        });

        $('.refreshInfo').click(function (event) {
            event.preventDefault();
            location.reload();
        });

        $('.bookedTicketsForm').on('submit', function (event) {
            event.preventDefault();
            submitParams(actionParam);
        });

        $('.clearBtn').click(function (event) {
            var result = {};
            $(".bookedTickets input").each(function (i, input) {
                result[input.name] = input.checked;
            });

            if (actionParam == 'clear') {
                $.ajax({
                    url: "/booking/clear/",
                    type: "post",
                    dataType: "json",
                    data: JSON.stringify(result),
                    contentType: "application/json; charset=utf-8",
                    success: positiveHandler,
                    error: negativeHandler
                });
            }
        });

        $('.buyBtn').click(function (event) {
            window.location.href = '/payment';
        });

        function positiveHandler(data) {
            if (data.status == 'success')
                alert(data.message);
            location.reload();
        }

        function negativeHandler(data) {
            var resp = data.responseJSON;
            if (resp.message) {
                alert(resp.message);
                return;
            }
            alert("something went wrong :(")
        }

        function userUpdNegativeHandler(data) {
            var resp = data.responseJSON;
            if (resp.message) {
                alert(resp.message);
                return;
            }
            alert("something went wrong :(");
        }

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                    // Only send the token to relative URLs i.e. locally.
                    xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                }
            }
        });

    </script>

{% endblock %}