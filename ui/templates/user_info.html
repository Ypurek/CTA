{% extends 'base.html' %}

{% block content %}
    <style>
        body {
            padding: 20px;
        }

        .ticketTable {
            border-left: 1px solid #000;
            border-top: 1px solid #000;
            margin: 0 0 20px;
        }

        .ticketTable td {
            border-right: 1px solid #000;
            border-bottom: 1px solid #000;
            padding: 5px;
        }
    </style>
    <div align="right"><a href="/booking/">booking</a></div>
    <div align="right"><a href="/logout/">logout</a></div>
    <h2>User Info</h2>
    <table class="ticketTable">
        <tr>
            <td>Name</td>
            <td>{{ user.username }}</td>
        </tr>
        <tr>
            <td>email</td>
            <td><input type="text" class="email" name="email" {% if user.profile.email %}
                       value="{{ user.profile.email }}" {% endif %}></td>
        </tr>
        <tr>
            <td>Credit Card</td>
            <td><input type="text" class="creditCard" name="creditCard"
                       value="{{ user.profile.credit_card.card_number }}"></td>
        </tr>
        <tr>
            <td>Delivery address</td>
            <td><textarea class="deliveryInfo" name="address">{% if user.profile.address %}{{ user.profile.address }}{% endif %}</textarea></td>
        </tr>
    </table>
    <input class="updateInfo" type="submit" name="updateInfo" value="update info"/>
    <input class="refreshInfo" type="submit" name="refreshInfo" value="refresh info"/>

    <h2>Booked Tickets</h2>
    <form action="/buy" method="post" class="bookedTicketsForm">
        <table class="ticketTable bookedTickets">
            <tr>
                <td>ID</td>
                <td>Date</td>
                <td>Time</td>
                <td>Name</td>
                <td>Price</td>
                <td>Time booked</td>
                <td>Remove</td>
            </tr>
            {% for ticket in booked_tickets_list %}
                <tr>
                    <td>{{ ticket.id }}</td>
                    <td>{{ ticket.performance.date|date:"d/m/Y" }}</td>
                    <td>{{ ticket.performance.time|time:"H:i" }}</td>
                    <td>{{ ticket.performance.name }}</td>
                    <td>{{ ticket.performance.price }}</td>
                    <td class="book_timer">{{ ticket.booked|date:"DATETIME_FORMAT" }}</td>
                    <td><input type="checkbox" name="{{ ticket.id }}"/></td>
                </tr>
            {% endfor %}
        </table>
        <input class="clearBtn" type="submit" name="action" value="clear selected"/>
        <input class="buyBtn" type="submit" name="action" value="buy"/>
    </form>

    <h2>Bought Tickets</h2>
    <table class="ticketTable boughtTickets">
        <tr>
            <td>ID</td>
            <td>Date</td>
            <td>Time</td>
            <td>Name</td>
            <td>Price</td>
            <td>Time Bought</td>
        </tr>
        {% for ticket in bought_tickets_list %}
            <tr>
                <td>{{ ticket.id }}</td>
                <td>{{ ticket.performance.date|date:"d/m/Y" }}</td>
                <td>{{ ticket.performance.time|time:"H:i" }}</td>
                <td>{{ ticket.performance.name }}</td>
                <td>{{ ticket.performance.price }}</td>
                <td>{{ ticket.bought|date:"DATETIME_FORMAT" }}</td>
            </tr>
        {% endfor %}
    </table>

    <script>
        $('.creditCard').on('input', function (event) {
            var res = '';
            if (this.value.length >= 19) {
                this.value = this.value.substr(0, 19);
                return;
            }
            var p = this.value.replace(/\D/g, '');
            var q = [];
            var c = 0;
            do {
                var sub = p.substr(c * 4, 4);
                if (sub.length == 0)
                    break;
                q.push(sub)
            } while (c++ * 4 + 4 < p.length)
            q.forEach(function (item, i) {
                res += item;
                if (i < 3 && item.length === 4) {
                    res += '-';
                }
            });
            if (res.slice(-1) === '-')
                res = res.substr(0, res.length - 1)
            else
                this.value = res;
        })

        $('.updateInfo').click(function (event) {
            event.preventDefault();
            $.ajax({
                url: "/user/update",
                type: "post",
                dataType: "json",
                data: JSON.stringify({
                    'email': $('.email').val(),
                    'creditCard': $('.creditCard').val(),
                    'deliveryAddress': $('.deliveryInfo').val()
                }),
                contentType: "application/json; charset=utf-8",
                success: function () {
                    location.reload();
                },
                error: userUpdNegativeHandler
            });
        });

        $('.refreshInfo').click(function (event) {
            event.preventDefault();
            location.reload();
        });

        $('.bookedTicketsForm').on('submit', function (event) {
            event.preventDefault();
            submitParams(actionParam);
        });

        $('.clearBtn').click(function (event) {
            var result = {};
            $(".bookedTickets input").each(function (i, input) {
                result[input.name] = input.checked;
            });

            if (actionParam == 'clear') {
                $.ajax({
                    url: "/booking/clear/",
                    type: "post",
                    dataType: "json",
                    data: JSON.stringify(result),
                    contentType: "application/json; charset=utf-8",
                    success: positiveHandler,
                    error: negativeHandler
                });
            }
        });

        $('.buyBtn').click(function (event) {
            window.location.href = '/payment';
        });

        function positiveHandler(data) {
            if (data.status == 'success')
                alert(data.message);
            location.reload();
        }

        function negativeHandler(data) {
            var resp = data.responseJSON;
            if (resp.message) {
                alert(resp.message);
                return;
            }
            alert("something went wrong :(")
        }

        function userUpdNegativeHandler(data) {
            var resp = data.responseJSON;
            if (resp.message) {
                alert(resp.message);
                return;
            }
            alert("something went wrong :(");
        }

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                    // Only send the token to relative URLs i.e. locally.
                    xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                }
            }
        });

    </script>

{% endblock %}